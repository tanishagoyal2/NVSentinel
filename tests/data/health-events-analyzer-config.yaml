apiVersion: v1
kind: ConfigMap
metadata:
  name: health-events-analyzer-config
  namespace: nvsentinel
data:
  config.toml: |
    [[rules]]
    name = "MultipleRemediations"
    description = "Detect if multiple remediations are performed within 1.5 minutes on a node"
    recommended_action = "CONTACT_SUPPORT"

    stage = [
      '''
      {
        "$match": {
          "$expr": {
            "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 90]}
            ]
          }
        }
      }
      ''',
      '''
      {
        "$match": {
          "healtheventstatus.faultremediated": true,
          "healthevent.nodename": "this.healthevent.nodename",
          "healthevent.isfatal": "this.healthevent.isfatal"
        }
      }
      ''',
      '{"$count": "count"}',
      '{"$match": {"count": {"$gte": 5}}}'
    ]

    [[rules]]
    name = "RepeatedXidError"
    description = "Detect occurrence of fatal XIDs 2 times within 5 minutes (E2E test window) where the burst window is 10 seconds and sticky XIDs window is 20seconds"
    recommended_action = "CONTACT_SUPPORT"
    stage = [
      '''
      {
        "$match": {
          "$expr": {
            "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 300]}
            ]
          }
        }
      }
      ''',
      '''
      {
        "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "$expr": {
            "$gt": [
              {
                "$size": {
                  "$setIntersection": [
                    {
                      "$map": {
                        "input": {
                          "$filter": {
                            "input": {"$ifNull": ["$healthevent.entitiesimpacted", []]},
                            "cond": {"$eq": ["$$this.entitytype", "GPU"]}
                          }
                        },
                        "in": "$$this.entityvalue"
                      }
                    },
                    {
                      "$map": {
                        "input": {
                          "$filter": {
                            "input": {"$ifNull": ["this.healthevent.entitiesimpacted", []]},
                            "cond": {"$eq": ["$$this.entitytype", "GPU"]}
                          }
                        },
                        "in": "$$this.entityvalue"
                      }
                    }
                  ]
                }
              },
              0
            ]
          }
        }
      }
      ''',
      '''
      {
        "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
            "prevTimestamp": {
              "$shift": {
                "output": "$healthevent.generatedtimestamp.seconds",
                "by": -1
              }
            }
          }
        }
      }
      ''',
      '''
      {
        "$addFields": {
          "isStickyXid": {
            "$in": [
              {"$arrayElemAt": ["$healthevent.errorcode", 0]},
              ["74", "79", "95", "109", "119"]
            ]
          }
        }
      }
      ''',
      '''
      {
        "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
            "allPreviousEvents": {
              "$push": "$$ROOT",
              "window": {"documents": ["unbounded", -1]}
            }
          }
        }
      }
      ''',
      '''
      {
        "$addFields": {
          "stickyXidWithin3Hours": {
            "$cond": {
              "if": "$isStickyXid",
              "then": {
                "$anyElementTrue": {
                  "$map": {
                    "input": "$allPreviousEvents",
                    "as": "prevEvent",
                    "in": {
                      "$and": [
                        {
                          "$in": [
                            {"$arrayElemAt": ["$$prevEvent.healthevent.errorcode", 0]},
                            ["74", "79", "95", "109", "119"]
                          ]
                        },
                        {"$lte": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$$prevEvent.healthevent.generatedtimestamp.seconds"]}, 20]}
                      ]
                    }
                  }
                }
              },
              "else": false
            }
          }
        }
      }
      ''',
      '''
      {
        "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
            "burstId": {
              "$sum": {
                "$cond": {
                  "if": {"$eq": ["$prevTimestamp", null]},
                  "then": 1,
                  "else": {
                    "$cond": {
                      "if": {
                        "$and": [
                          "$isStickyXid",
                          "$stickyXidWithin3Hours"
                        ]
                      },
                      "then": 0,
                      "else": {
                        "$cond": {
                          "if": {"$gt": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$prevTimestamp"]}, 10]},
                          "then": 1,
                          "else": 0
                        }
                      }
                    }
                  }
                }
              },
              "window": {"documents": ["unbounded", "current"]}
            }
          }
        }
      }
      ''',
      '''
      {
        "$group": {
          "_id": {"burstId": "$burstId"},
          "uniqueXidsInBurst": {"$addToSet": {"$arrayElemAt": ["$healthevent.errorcode", 0]}},
          "targetXidCount": {
            "$sum": {
              "$cond": [
                {"$eq": [{"$arrayElemAt": ["$healthevent.errorcode", 0]}, "this.healthevent.errorcode.0"]},
                1,
                0
              ]
            }
          }
        }
      }
      ''',
      '''
      {
        "$setWindowFields": {
          "sortBy": {"_id.burstId": 1},
          "output": {"maxBurstId": {"$max": "$_id.burstId"}}
        }
      }
      ''',
      '''
      {
        "$match": {
          "$expr": {
            "$and": [
              {"$in": ["this.healthevent.errorcode.0", "$uniqueXidsInBurst"]},
              {
                "$or": [
                  {"$ne": ["$_id.burstId", "$maxBurstId"]},
                  {"$eq": ["$targetXidCount", 1]}
                ]
              }
            ]
          }
        }
      }
      ''',
      '''
      {
        "$group": {
          "_id": null,
          "count": {"$sum": 1},
          "bursts": {"$push": {"burstId": "$_id.burstId", "uniqueXids": "$uniqueXidsInBurst"}}
        }
      }
      ''',
      '{"$match": {"count": {"$gte": 2}}}'
    ]