apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: event-generator
  namespace: nvsentinel
  labels:
    app: event-generator
spec:
  selector:
    matchLabels:
      app: event-generator
  template:
    metadata:
      labels:
        app: event-generator
    spec:
      # Only run on worker nodes (if you have node labels for system nodes)
      # Adjust or remove nodeAffinity based on your cluster setup
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              # Example: Skip nodes with specific labels
              # Customize for your environment or remove this section
              - key: node-role.kubernetes.io/master
                operator: DoesNotExist
      
      # Allow running on nodes with taints
      tolerations:
      - operator: "Exists"
      
      # Pull secret for NGC registry
      imagePullSecrets:
      - name: nvidia-ngcuser-pull-secret
      
      containers:
      - name: event-generator
        # ⚠️  CHANGE THIS IMAGE to your own registry!
        # Replace "ghcr.io/nvidia/nvsentinel" with your registry
        # Build instructions: tests/scale-tests/event-generator/BUILD.md
        # 
        # One-line update:
        #   sed -i 's|ghcr.io/nvidia/nvsentinel|YOUR_REGISTRY|g' manifests/event-generator-daemonset.yaml
        #
        image: ghcr.io/nvidia/nvsentinel/event-generator:v1
        imagePullPolicy: Always
        
        # Environment variables from ConfigMap and downward API
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: EVENT_RATE
          valueFrom:
            configMapKeyRef:
              name: event-generator-config
              key: EVENT_RATE
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: event-generator-config
              key: LOG_LEVEL
              optional: true
        
        # Command line args (only socket path, everything else via env vars)
        args:
        - "-socket=/var/run/nvsentinel/nvsentinel.sock"
        
        # Mount the Unix socket directory from host
        volumeMounts:
        - name: nvsentinel-socket
          mountPath: /var/run
          readOnly: false
        
        securityContext:
          runAsUser: 0
          allowPrivilegeEscalation: true
        
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      
      # Mount the Unix socket directory from host
      volumes:
      - name: nvsentinel-socket
        hostPath:
          path: /var/run
          type: Directory

