# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

replicaCount: 1

image:
  repository: ghcr.io/nvidia/nvsentinel/health-events-analyzer
  pullPolicy: IfNotPresent
  tag: ""

podAnnotations: {}

resources:
  limits:
    cpu: "1"
    memory: "1Gi"
  requests:
    cpu: "1"
    memory: "1Gi"

logLevel: info

# Client certificate mount path for database connections
clientCertMountPath: /etc/ssl/client-certs

config: |
  # The node condition for these rules needs to be removed manually because health-events-analyzer does not publish healthy events to clear it.
  # Please run the command below to remove the node condition:
  # kubectl get node <NODE_NAME> -o json | jq '.status.conditions |= map(select(.type != "<NAME_OF_APPLIED_RULE>"))' | kubectl replace -f - --subresource=status
  [[rules]]
  name = "MultipleRemediations"
  description = "Detect if multiple remediations are performed within 7 days on a node"
  recommended_action = "CONTACT_SUPPORT"
  stage = [
    '''
    {
      "$match": {
        "$expr": {
          "$gte": [
            "$healthevent.generatedtimestamp.seconds",
            {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 604800]}
          ]
        }
      }
    }
    ''',
    '''
    {
      "$match": {
        "healtheventstatus.faultremediated": true,
        "healthevent.nodename": "this.healthevent.nodename",
        "healthevent.isfatal": "this.healthevent.isfatal"
      }
    }
    ''',
    '{"$count": "count"}',
    '{"$match": {"count": {"$gte": 5}}}'
  ]

  [[rules]]
  name = "RepeatedXidErrorOnSameGPU"
  description = "Detect occurrence of fatal XIDs within 24 hours where the burst window is 3 minutes and sticky XIDs window is 3 hours. Count threshold: 2 for XID-31, 5 for others"
  recommended_action = "CONTACT_SUPPORT"
  recommended_action_mappings = { "31" = { recommended_action = "RUN_DCGMEUD", message = "if pass: RUN_FIELDDIAGS" } }

  stage = [
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 86400]}
          ]
          }
      }
      }
      ''',
      '''
      {
      "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "$expr": {
          "$gt": [
              {
              "$size": {
                  "$setIntersection": [
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": {"$ifNull": ["$healthevent.entitiesimpacted", []]},
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  },
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "this.healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  }
                  ]
              }
              },
              0
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "prevTimestamp": {
              "$shift": {
              "output": "$healthevent.generatedtimestamp.seconds",
              "by": -1
              }
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "isStickyXid": {
          "$in": [
              {"$arrayElemAt": ["$healthevent.errorcode", 0]},
              ["74", "79", "95", "109", "119"]
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "allPreviousEvents": {
              "$push": "$$ROOT",
              "window": {"documents": ["unbounded", -1]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "stickyXidWithin3Hours": {
          "$cond": {
              "if": "$isStickyXid",
              "then": {
              "$anyElementTrue": {
                  "$map": {
                  "input": "$allPreviousEvents",
                  "as": "prevEvent",
                  "in": {
                      "$and": [
                      {
                          "$in": [
                          {"$arrayElemAt": ["$$prevEvent.healthevent.errorcode", 0]},
                          ["74", "79", "95", "109", "119"]
                          ]
                      },
                      {"$lte": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$$prevEvent.healthevent.generatedtimestamp.seconds"]}, 10800]}
                      ]
                  }
                  }
              }
              },
              "else": false
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "burstId": {
              "$sum": {
              "$cond": {
                  "if": {"$eq": ["$prevTimestamp", null]},
                  "then": 1,
                  "else": {
                  "$cond": {
                      "if": {
                      "$and": [
                          "$isStickyXid",
                          "$stickyXidWithin3Hours"
                      ]
                      },
                      "then": 0,
                      "else": {
                      "$cond": {
                          "if": {"$gt": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$prevTimestamp"]}, 180]},
                          "then": 1,
                          "else": 0
                      }
                      }
                  }
                  }
              }
              },
              "window": {"documents": ["unbounded", "current"]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": {"burstId": "$burstId"},
          "uniqueXidsInBurst": {"$addToSet": {"$arrayElemAt": ["$healthevent.errorcode", 0]}},
          "targetXidCount": {
          "$sum": {
              "$cond": [
              {"$eq": [{"$arrayElemAt": ["$healthevent.errorcode", 0]}, "this.healthevent.errorcode.0"]},
              1,
              0
              ]
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"_id.burstId": 1},
          "output": {"maxBurstId": {"$max": "$_id.burstId"}}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$and": [
              {"$in": ["this.healthevent.errorcode.0", "$uniqueXidsInBurst"]},
              {
              "$or": [
                  {"$ne": ["$_id.burstId", "$maxBurstId"]},
                  {"$eq": ["$targetXidCount", 1]}
              ]
              }
          ]
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": null,
          "count": {"$sum": 1},
          "bursts": {"$push": {"burstId": "$_id.burstId", "uniqueXids": "$uniqueXidsInBurst"}}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$count",
              {
              "$switch": {
                  "branches": [
                  { "case": { "$eq": ["this.healthevent.errorcode.0", "31"] }, "then": 2 }
                  ],
                  "default": 5
              }
              }
          ]
          }
      }
      }
      '''
  ]

  [[rules]]
  name = "RepeatedXidErrorOnDifferentGPU"
  description = "Detect occurrence of XIDs on 2 or more different GPUs within 24 hours"
  message = "run CHECK_APP_CUDA"
  recommended_action = "NONE"
  stage = [
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 86400]}
          ]
          }
      }
      }
      ''',
      '''
      {
      "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "healthevent.errorcode": "this.healthevent.errorcode.0"
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "gpuUuid": {
          "$let": {
              "vars": {
              "uuid": {
                  "$arrayElemAt": [
                  {
                      "$map": {
                      "input": {"$filter": {"input": {"$ifNull": ["$healthevent.entitiesimpacted", []]}, "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}}},
                      "in": "$$this.entityvalue"
                      }
                  },
                  0
                  ]
              }
              },
              "in": {
              "$cond": [
                  {"$ne": ["$$uuid", null]},
                  "$$uuid",
                  null
              ]
              }
          }
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": null,
          "uniqueGPUs": {"$addToSet": "$gpuUuid"}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [{"$size": "$uniqueGPUs"}, 2]
          }
      }
      }
      '''
  ]

  [[rules]]
  name = "XIDErrorOnSameGPCAndTPC"
  description = "Detect if XID error occurred 2 or more times on the same GPC and TPC within 24 hours"
  message = "if pass run RUN_FIELDDIAGS" 
  recommended_action = "RUN_DCGMEUD"
  stage = [
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 86400]}
          ]
          }
      }
      }
      ''',
      '''
      {
      "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "$expr": {
          "$gt": [
              {
              "$size": {
                  "$setIntersection": [
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "$healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  },
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "this.healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  }
                  ]
              }
              },
              0
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "prevTimestamp": {
              "$shift": {
              "output": "$healthevent.generatedtimestamp.seconds",
              "by": -1
              }
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "isStickyXid": {
          "$in": [
              {"$arrayElemAt": ["$healthevent.errorcode", 0]},
              ["74", "79", "95", "109", "119"]
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "allPreviousEvents": {
              "$push": "$$ROOT",
              "window": {"documents": ["unbounded", -1]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "stickyXidWithin3Hours": {
          "$cond": {
              "if": "$isStickyXid",
              "then": {
              "$anyElementTrue": {
                  "$map": {
                  "input": "$allPreviousEvents",
                  "as": "prevEvent",
                  "in": {
                      "$and": [
                      {
                          "$in": [
                          {"$arrayElemAt": ["$$prevEvent.healthevent.errorcode", 0]},
                          ["74", "79", "95", "109", "119"]
                          ]
                      },
                      {"$lte": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$$prevEvent.healthevent.generatedtimestamp.seconds"]}, 10800]}
                      ]
                  }
                  }
              }
              },
              "else": false
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "burstId": {
              "$sum": {
              "$cond": {
                  "if": {"$eq": ["$prevTimestamp", null]},
                  "then": 1,
                  "else": {
                  "$cond": {
                      "if": {
                      "$and": [
                          "$isStickyXid",
                          "$stickyXidWithin3Hours"
                      ]
                      },
                      "then": 0,
                      "else": {
                      "$cond": {
                          "if": {"$gt": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$prevTimestamp"]}, 180]},
                          "then": 1,
                          "else": 0
                      }
                      }
                  }
                  }
              }
              },
              "window": {"documents": ["unbounded", "current"]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": {"burstId": "$burstId"},
          "uniqueXidsInBurst": {"$addToSet": {"$arrayElemAt": ["$healthevent.errorcode", 0]}},
          "targetXidCount": {
          "$sum": {
              "$cond": [
              {
                  "$and": [
                  {"$eq": [{"$arrayElemAt": ["$healthevent.errorcode", 0]}, "this.healthevent.errorcode.0"]},
                  {
                      "$eq": [
                      {
                          "$arrayElemAt": [
                          {
                              "$map": {
                              "input": {"$filter": {"input": "$healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "GPC"]}}},
                              "in": "$$this.entityvalue"
                              }
                          },
                          0
                          ]
                      },
                      {
                          "$arrayElemAt": [
                          {
                              "$map": {
                              "input": {"$filter": {"input": "this.healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "GPC"]}}},
                              "in": "$$this.entityvalue"
                              }
                          },
                          0
                          ]
                      }
                      ]
                  },
                  {
                      "$eq": [
                      {
                          "$arrayElemAt": [
                          {
                              "$map": {
                              "input": {"$filter": {"input": "$healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "TPC"]}}},
                              "in": "$$this.entityvalue"
                              }
                          },
                          0
                          ]
                      },
                      {
                          "$arrayElemAt": [
                          {
                              "$map": {
                              "input": {"$filter": {"input": "this.healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "TPC"]}}},
                              "in": "$$this.entityvalue"
                              }
                          },
                          0
                          ]
                      }
                      ]
                  }
                  ]
              },
              1,
              0
              ]
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"_id.burstId": 1},
          "output": {"maxBurstId": {"$max": "$_id.burstId"}}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$and": [
              {"$in": ["this.healthevent.errorcode.0", "$uniqueXidsInBurst"]},
              {"$gt": ["$targetXidCount", 0]},
              {
              "$or": [
                  {"$ne": ["$_id.burstId", "$maxBurstId"]},
                  {"$gte": ["$targetXidCount", 1]}
              ]
              }
          ]
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": null,
          "count": {"$sum": 1},
          "bursts": {"$push": {"burstId": "$_id.burstId", "uniqueXids": "$uniqueXidsInBurst"}}
      }
      }
      ''',
      '{"$match": {"count": {"$gte": 2}}}'
  ]

  [[rules]]
  name = "XIDErrorOnDifferentGPCAndTPC"
  description = "Detect if XID error occurred on 2 or more different GPC and TPC combinations within 24 hours"
  message = "run CHECK_APP_CUDA"
  recommended_action = "NONE"
  stage = [
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 86400]}
          ]
          }
      }
      }
      ''',
      '''
      {
      "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "healthevent.errorcode": "this.healthevent.errorcode.0",
          "$expr": {
          "$gt": [
              {
              "$size": {
                  "$setIntersection": [
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "$healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  },
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "this.healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  }
                  ]
              }
              },
              0
          ]
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "gpcTpcCombination": {
          "$let": {
              "vars": {
              "gpc": {
                  "$arrayElemAt": [
                  {
                      "$map": {
                      "input": {"$filter": {"input": "$healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "GPC"]}}},
                      "in": "$$this.entityvalue"
                      }
                  },
                  0
                  ]
              },
              "tpc": {
                  "$arrayElemAt": [
                  {
                      "$map": {
                      "input": {"$filter": {"input": "$healthevent.entitiesimpacted", "cond": {"$eq": ["$$this.entitytype", "TPC"]}}},
                      "in": "$$this.entityvalue"
                      }
                  },
                  0
                  ]
              }
              },
              "in": {
              "$cond": [
                  {"$and": [{"$ne": ["$$gpc", null]}, {"$ne": ["$$tpc", null]}]},
                  {"$concat": ["GPC:", "$$gpc", "-TPC:", "$$tpc"]},
                  null
              ]
              }
          }
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": null,
          "uniqueGPCAndTPCCombinations": {"$addToSet": "$gpcTpcCombination"}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [{"$size": "$uniqueGPCAndTPCCombinations"}, 2]
          }
      }
      }
      '''
  ]

  [[rules]]
  name = "XIDErrorSoloNoBurst"
  description = "Detect if XID error occurred only once in the last burst within 24 hours time window"
  message = "run CHECK_APP_CUDA"
  recommended_action = "NONE"
  stage = [
      '''
      {
      "$match": {
          "$expr": {
          "$gte": [
              "$healthevent.generatedtimestamp.seconds",
              {"$subtract": [{"$divide": [{"$toLong": "$$NOW"}, 1000]}, 86400]}
          ]
          }
      }
      }
      ''',
      '''
      {
      "$match": {
          "healthevent.ishealthy": false,
          "healthevent.nodename": "this.healthevent.nodename",
          "$expr": {
          "$gt": [
              {
              "$size": {
                  "$setIntersection": [
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "$healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  },
                  {
                      "$map": {
                      "input": {
                          "$filter": {
                          "input": "this.healthevent.entitiesimpacted",
                          "cond": {"$eq": ["$$this.entitytype", "GPU_UUID"]}
                          }
                      },
                      "in": "$$this.entityvalue"
                      }
                  }
                  ]
              }
              },
              0
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "prevTimestamp": {
              "$shift": {
              "output": "$healthevent.generatedtimestamp.seconds",
              "by": -1
              }
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "isStickyXid": {
          "$in": [
              {"$arrayElemAt": ["$healthevent.errorcode", 0]},
              ["74", "79", "95", "109", "119"]
          ]
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "allPreviousEvents": {
              "$push": "$$ROOT",
              "window": {"documents": ["unbounded", -1]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$addFields": {
          "stickyXidWithin3Hours": {
          "$cond": {
              "if": "$isStickyXid",
              "then": {
              "$anyElementTrue": {
                  "$map": {
                  "input": "$allPreviousEvents",
                  "as": "prevEvent",
                  "in": {
                      "$and": [
                      {
                          "$in": [
                          {"$arrayElemAt": ["$$prevEvent.healthevent.errorcode", 0]},
                          ["74", "79", "95", "109", "119"]
                          ]
                      },
                      {"$lte": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$$prevEvent.healthevent.generatedtimestamp.seconds"]}, 10800]}
                      ]
                  }
                  }
              }
              },
              "else": false
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"healthevent.generatedtimestamp.seconds": 1},
          "output": {
          "burstId": {
              "$sum": {
              "$cond": {
                  "if": {"$eq": ["$prevTimestamp", null]},
                  "then": 1,
                  "else": {
                  "$cond": {
                      "if": {
                      "$and": [
                          "$isStickyXid",
                          "$stickyXidWithin3Hours"
                      ]
                      },
                      "then": 0,
                      "else": {
                      "$cond": {
                          "if": {"$gt": [{"$subtract": ["$healthevent.generatedtimestamp.seconds", "$prevTimestamp"]}, 180]},
                          "then": 1,
                          "else": 0
                      }
                      }
                  }
                  }
              }
              },
              "window": {"documents": ["unbounded", "current"]}
          }
          }
      }
      }
      ''',
      '''
      {
      "$group": {
          "_id": {"burstId": "$burstId"},
          "targetXidCount": {
          "$sum": {
              "$cond": [
              {"$eq": [{"$arrayElemAt": ["$healthevent.errorcode", 0]}, "this.healthevent.errorcode.0"]},
              1,
              0
              ]
          }
          }
      }
      }
      ''',
      '''
      {
      "$setWindowFields": {
          "sortBy": {"_id.burstId": 1},
          "output": {"maxBurstId": {"$max": "$_id.burstId"}}
      }
      }
      ''',
      '''
      {
      "$match": {
          "$expr": {
          "$and": [
              {"$eq": ["$_id.burstId", "$maxBurstId"]},
              {"$eq": ["$targetXidCount", 1]}
          ]
          }
      }
      }
      '''
  ]